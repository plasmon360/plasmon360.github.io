<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Controlling SP2150i monochromator with Python/PyVisa</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">A Pelican Blog </a></h1>
                <nav><ul>
                    <li><a href="/category/electronics.html">Electronics</a></li>
                    <li><a href="/category/free-software.html">Free Software</a></li>
                    <li><a href="/category/free-software-latex-publications.html">Free Software, Latex, Publications</a></li>
                    <li><a href="/category/free-software-linux.html">Free Software, Linux</a></li>
                    <li><a href="/category/free-software-matlab-plasmonics.html">Free Software, Matlab, Plasmonics</a></li>
                    <li><a href="/category/free-software-plasmonics.html">Free Software, Plasmonics</a></li>
                    <li><a href="/category/free-software-plasmonics-publications.html">Free Software, Plasmonics, Publications</a></li>
                    <li><a href="/category/linux-ramblings.html">Linux, Ramblings</a></li>
                    <li><a href="/category/matlab.html">Matlab</a></li>
                    <li><a href="/category/plasmonics.html">Plasmonics</a></li>
                    <li><a href="/category/plasmonics-publications.html">Plasmonics, Publications</a></li>
                    <li><a href="/category/plasmonics-researc.html">Plasmonics, Researc</a></li>
                    <li><a href="/category/publications.html">Publications</a></li>
                    <li><a href="/category/publications-test-equipment.html">Publications, Test Equipment</a></li>
                    <li><a href="/category/python.html">Python</a></li>
                    <li class="active"><a href="/category/test-equipment.html">Test Equipment</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/controlling-sp2150i-monochromator-with-pythonpyvisa.html" rel="bookmark"
           title="Permalink to Controlling SP2150i monochromator with Python/PyVisa">Controlling SP2150i monochromator with Python/PyVisa</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-09-19T18:28:00+00:00">
                Published: Fri 19 September 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/juluribk.html">juluribk</a>
        </address>
<p>In <a href="/category/test-equipment.html">Test Equipment</a>.</p>

</footer><!-- /.post-info -->      <p>Monochromator is used in optics research where a narrow bandwidth of light is required to be illuminated on a sample. I work with Princeton Instruments Acton SP2150i and needed a python program to control it.</p>
<p>I found the manual <a href="ftp://ftp.princetoninstruments.com/public/Manuals/Acton/SP-2150i.pdf">here</a> and on page 9-10, I saw the serial commands for various functions (such as changing filters, moving the grating, etc).</p>
<p>To control the instrument with my windows computer, I followed these steps:</p>
<p><strong>1) Connect a usb cable between SP2150 and a computer</strong><br>
I used the port "USB" and not the "USB hub".</p>
<p><strong>2) Installing the monochromator drivers and Monocontrol software:</strong></p>
<p>Turned on the monochromator and when prompted, I Installed Princeton Instruments VCP drivers (version 2.08.08). These drivers should be in Acton Monochromator Control Software installation Disk.  If the drivers are installed properly, you should see the monochromator as a Princeton Instruments Spectral device(COMx), in the device manager. x could be any number.</p>
<p><a href="http://juluribk.com/wp-content/uploads/2014/09/device_manager_11.png"><img alt="device_manager_1" class="aligncenter" height="414" src="http://juluribk.com/wp-content/uploads/2014/09/device_manager_11.png" width="575"></a></p>
<p>Before attempting to control the instrument with python/pyvisa, I checked if the computer can communicate with monochromator using  "MonoControl". See the installation instructions <a href="ftp://ftp.princetoninstruments.com/public/Manuals/Acton/Monochromator_Control_Software_Manual.pdf">here</a> . Monocontrol allows for control of monochromator which will open a windows like this:</p>
<p><a href="http://juluribk.com/wp-content/uploads/2014/09/monocontrol1.png"><img alt="monocontrol1" class="wp-image-1322 aligncenter" height="410" src="http://juluribk.com/wp-content/uploads/2014/09/monocontrol1.png" width="512"></a></p>
<p>If you cannot reach this stage, then there is some problem with drivers and need to be fixed before you can use python/pyvisa to control the instrument. Close this software if you want to use it with pyvisa.</p>
<p><strong>3) Install NI-VISA runtime </strong><br>
I downloaded the exe from National Instruments and installed it. This should provide the required visa32.dll</p>
<p><strong>4) Install python2.7 and Pyvisa </strong></p>
<p>You can install pyvisa using Pip</p>
<p><strong>5) Python code</strong></p>
<p>I wrote a module that can be used to control the monochromator using pyvisa commands. The module provides a class definition and some high level functions. For the line, "self.m=instrument('COM7', timeout = 10)", change 7 to the right com port number. The number should match the com port number shown in the device manager. This module can be loaded into other python codes and the high level functions can be used to write even higher level functions (for example, see the code after if __name__ == "__main__":) . The specifics of the code are valid for the set of filters,turrets and gratings I use in my instrument, but the program can be used for other cases with slight modifications. You can also download the code <a href="http://juluribk.com/wp-content/uploads/2014/09/SP2150i.txt">here</a>.</p>
<p><em id="__mceDel"> [cc lang="python"]<br>
"""<br>
Created on Fri Sep 19 18:11:40 2014</p>
<p>@author: Bala Krishna Juluri<br>
"""</p>
<p>from visa import *<br>
import time<br>
#assumes connected with USB. Drivers are installed. Needs pyvisa for communication.<br>
# There is no need to use visa write command for SP2150. because all commands are ask type (you write something and get a confirmation back saying OK)<br>
# filter 1 is no filter<br>
# filter 2 is in 320 nm long pass filter<br>
# filter 3 is 590 long pass filter cutoff<br>
# filter 4 is 715 long pass filter<br>
# filter 5 is 1250 long pass filter<br>
#filter 6 is block</p>
<p>class SP2150i():<br>
def __init__(self):<br>
#self.m=instrument(get_instruments_list()[0])<br>
try:<br>
print get_instruments_list()<br>
self.m=instrument('COM7', timeout = 10) #he default timeout is 5 sec, change the timeout if needed<br>
except:<br>
print "Check if monochromotor is connected to right COM port of instrument list (see control panel, hardward devices). Cannot connect to monochromator. Check connection. Check drivers"</p>
<p>def get_nm(self):<br>
self.curr_nm=self.m.ask_for_values('?NM')<br>
return self.curr_nm</p>
<p>def get_nm_per_min(self):<br>
self.curr_nm_min=self.m.ask_for_values('?NM/MIN')<br>
return self.curr_nm_min</p>
<p>def get_serial_model(self):<br>
self.serial_no=self.m.ask_for_values('SERIAL')<br>
self.model_no=self.m.ask_for_values('MODEL')<br>
return self.serial_no,self.model_no</p>
<p>def goto_nm_max_speed(self,nm):<br>
self.m.ask('%0.2f GOTO' % nm)</p>
<p>def get_turret(self):<br>
self.turret=self.m.ask_for_values('?TURRET')<br>
return self.turret</p>
<p>def get_filter(self):<br>
self.filter=self.m.ask_for_values('?FILTER')<br>
time.sleep(2)<br>
return self.filter</p>
<p>def get_grating(self):<br>
self.grating=self.m.ask_for_values('?GRATING')<br>
return self.grating</p>
<p>def set_turret(self,num):<br>
if num &lt;=2:<br>
self.m.ask(str(int(num))+ ' TURRET')<br>
else:<br>
print "There is not turret with this input"</p>
<p>def set_filter(self,num):<br>
if num &lt;=6:<br>
self.m.ask(str(int(num))+ ' FILTER')<br>
print "Filter changed and waiting with additional delay..."<br>
time.sleep(1) # Additional delay, just in case.<br>
print "Done waiting"<br>
else:<br>
print "There is no filter with this input"</p>
<p>def set_grating(self,num):<br>
if num&lt;=2:<br>
self.m.ask(str(int(num))+ ' GRATING')<br>
#time.sleep(5) # Additional delay, just in case<br>
else:<br>
print "There is no grating with this input"</p>
<p>def goto_nm_with_set_nm_per_min(self,nm,nm_per_min):<br>
self.m.ask('%0.2f NM/MIN' % nm_per_min)<br>
self.m.ask('%0.2f &gt;NM' % nm)<br>
char=0<br>
while char!=1:<br>
s=self.m.ask('MONO-?DONE')<br>
char=int(s[2])<br>
#print "Current wavelength is "+ self.m.ask('?NM')<br>
time.sleep(.2)<br>
print "Scan done?: "+'yes' if char == 1 else 'No'<br>
self.m.ask('MONO-STOP')<br>
return self.m.ask_for_values('?NM')</p>
<p>if __name__ == "__main__":<br>
#This part of the codes uses the SP2150i class to do a wavelength scan<br>
a=SP2150i()<br>
print a.get_serial_model()<br>
print a.get_grating()<br>
print a.get_filter()<br>
print a.get_nm_per_min()<br>
print a.get_nm()<br>
a.set_grating(2) # can only take 1 or 2 as input</p>
<p>start_wave=500<br>
end_wave=1000<br>
delta_wave=20<br>
speed_nm_per_min=2000<br>
a.set_filter(2) # this applies the 320 nm filter in the beginning<br>
for i in xrange(start_wave,end_wave,delta_wave):<br>
print "----------------------------"<br>
print "Wavelength input is %0.2f nm" % i<br>
wave=a.goto_nm_with_set_nm_per_min(i,speed_nm_per_min)</p>
<p>if i &lt;= 370 and i+delta_wave &gt;= 370:<br>
a.set_filter(2)</p>
<p>if i &lt;= 660 and i+delta_wave &gt;= 660:<br>
a.set_filter(3)</p>
<p>if i &lt;= 775 and i+delta_wave &gt;= 775:<br>
a.set_filter(4)</p>
<p>if i &lt;= 1300 and i+delta_wave &gt;= 1300:<br>
a.set_filter(5)</p>
<p>print "Wavelength output is "+str(wave[0])+ " nm"<br>
print "----------------------------"</p>
<p>print "Resetting the monochromator to home position"<br>
a.goto_nm_max_speed(400)<br>
a.set_filter(1)<br>
print "Position to home at " + str(a.get_nm()[0]) + " nm"+ ' and filter has been reset to ' + str(a.get_filter()[0])<br>
print "Monochromator scan done. Have a nice day!"</p>
<p>[/cc]</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>